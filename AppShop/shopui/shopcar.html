<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>购物车</title>
		<link rel="stylesheet" type="text/css" href="css/loaders.min.css" />
		<link rel="stylesheet" type="text/css" href="css/loading.css" />
		<link rel="stylesheet" type="text/css" href="css/base.css" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<style>
			li a p{
				margin: 0px;
			}
			.page-footer ul {				
				height: 4em;
			}
		</style>
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.back = function back() {
				//首次按键，提示‘再按一次退出应用’
				history.go(-1)
			}
		</script>
		<script type="text/javascript">
			$(window).load(function() {
				$(".loading").addClass("loader-chanage")
				$(".loading").fadeOut(300)
			})
		</script>
	</head>
	<!--loading页开始-->
	<div class="loading">
		<div class="loader">
			<div class="loader-inner pacman">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
		</div>
	</div>
	<!--loading页结束-->
	<body>
		<header class="page-header">
			<h3 id="header">购物车</h3>
		</header>
		<div class="mui-content">
			<ul id="OA_task_1" class="mui-table-view">
				<!-- <li>
				<div class="mui-slider-right mui-disabled">
					<a class="mui-btn mui-btn-red" id="delete"></a>
				</div>
				<div class="mui-slider-handle">
					<img class="mui-media-object mui-pull-left" style="line-height: 100px;max-width: 100px;height: 100px;" src="">
				<div class="mui-media-body">
				<dl>
					<dt id="title"></dt>
					<div class="mui-numbox" data-numbox-min="1">
					<button class="mui-btn mui-btn-numbox-minus" type="button" disabled>-</button>
						<input class="mui-input-numbox" type="number" data-prodid="'+data.RetData[i].ProdID+'" value="1"/>
					<button class="mui-btn mui-btn-numbox-plus" type="button">+</button></div>';
					<dd id="price"><span></span ><span>&nbsp</span></dd>
					<h3 id="totalprice" style="" >
						<span class="totalprice"></span>&nbsp;
						<span style="font-size:12px;color:red">
						<span class="totalinteg"></span><span></h3></dl>
				</div></div>
				</li>
				<li>
				<div class="mui-slider-right mui-disabled">
					<a class="mui-btn mui-btn-red" id="delete"></a>
				</div>
				<div class="mui-slider-handle">
					<img class="mui-media-object mui-pull-left" style="line-height: 100px;max-width: 100px;height: 100px;" src="">
				<div class="mui-media-body">
				<dl>
					<dt id="title"></dt>
					<div class="mui-numbox" data-numbox-min="1">
					<button class="mui-btn mui-btn-numbox-minus" type="button" disabled>-</button>
						<input class="mui-input-numbox" type="number" data-prodid="'+data.RetData[i].ProdID+'" value="1"/>
					<button class="mui-btn mui-btn-numbox-plus" type="button">+</button></div>';
					<dd id="price"><span></span ><span>&nbsp</span></dd>
					<h3 id="totalprice" style="" >
						<span class="totalprice"></span>&nbsp;
						<span style="font-size:12px;color:red">
						<span class="totalinteg"></span><span></h3></dl>
				</div></div>
				</li> -->
			</ul>
		</div>

		<footer class="page-footer fixed-footer">
			<!-- <div class="shop-go">
				<b style="width:70%" ><label id="money">￥108.90</label><label style="font-size: 12px;color: red;">&nbsp;总积分：<label id="integral"></label></label></b>
				<span style="width:100%" id="btn"><a href="buy.html">去结算</a></span>
			</div> -->
			<div class="mui-button-row">
				<button id="submit" type="button" class=" mui-btn-block mui-btn mui-btn-blue" style="padding: 12px 12px;font-weight: bolder;font-size: 16px;margin-bottom:0px ;">去结算</button>
			</div>
			<ul>
				<li>
					<a href="index.html">
						<img src="images/footer001.png" />
						<p id="index">首页</p>
					</a>
				</li>

				<li class="active">
					<a href="shopcar.html">
						<img src="images/footer03.png" />
						<p id="shoppingCar">购物车</p>
					</a>
				</li>
				<!-- <li>
					<a href="../main.html" style="    border: 3px solid #ccc;border-radius: 50%;text-align: center;
			vertical-align: middle;margin: auto;line-height: 40px;">
						<p style="margin-top: 0;">主页</p>
					</a>
				</li> -->
				<li>
					<a href="assort.html">
						<img src="images/footer002.png" />
						<p id="order">订单</p>
					</a>
				</li>
				<li>
					<a href="../main.html">
						<img src="images/footer004.png" />
						<p id="mainPage">主页</p>
					</a>
				</li>
			</ul>
		</footer>


	</body>
	<script src="../js/app.js"></script>
	<script src="../js/config.js"></script>
	<script src="../js/data.js"></script>
	<script>
		var userInfo = {};
		$(function() {
			userInfo = app.getSettings();
			var data = {
				"ReqSys": config.reqSys,
				"ReqKey": userInfo.UserID,
				"ReqPwd": userInfo.PwdTmp,
				"ReqType": "ScShopCartGet",
				"ReqData": null
			};
			jqAjax(data, initPage);
		});
		mui('.mui-button-row').on('tap', '#submit', function() {			
			window.location.href="buy.html";
		});
		function txtChange(){
			mui('.mui-numbox').on('change', '.mui-input-numbox', function() {
// 				alert(mui($(this).parent()[0]).numbox().getValue());
// 				alert(JSON.stringify(listPro["ProdID"+this.getAttribute("data-prodid")]));
// 				alert(mui($(this).parent()[0]).numbox().getValue()*listPro["ProdID"+this.getAttribute("data-prodid")].PPrice);				
				var $this=this;
				var userInfo = app.getSettings();
				var id = this.getAttribute("data-prodid");
				var param = {
					"ReqSys": config.reqSys,
					"ReqKey": userInfo.UserID,
					"ReqPwd": userInfo.PwdTmp,
					"ReqType": "ScShopCartUp",
					"ReqData": {
						"ProdID": id, // 商品ID
						"ProdNum": mui($(this).parent()[0]).numbox().getValue() // 商品数量，小于等于0时，表示删除，否则表示添加或修改
					}
				};
				$.ajax({
					async: true, //表示请求是否异步处理
					timeout: 50000,
					type: "post", //请求类型
					url: config.url, //请求的 URL地址
					data: JSON.stringify(param),
					contentType: "application/json",
					dataType: "json", //返回的数据类型
					success: function(data) {
						console.log(JSON.stringify(data)); //在控制台打印服务器端返回的数据						
						if (data.RetFlag < 0) {
							mui.toast(data.RetInfo);
							return;
						} else {
							console.log($($this).parent()[0].innerHTML);
							mui($($this).parent()[0]).numbox().setValue(mui($($this).parent()[0]).numbox().getValue());
							$($this).parent().parent().find('.totalprice')[0].innerHTML=mui($($this).parent()[0]).numbox().getValue()*listPro["ProdID"+$this.getAttribute("data-prodid")].PPrice;
							$($this).parent().parent().find('.totalinteg')[0].innerHTML=mui($($this).parent()[0]).numbox().getValue()*listPro["ProdID"+$this.getAttribute("data-prodid")].PInteg;
						}
					},
					error: function(data) {
						console.log(JSON.stringify(data));
						mui.toast(tempJson.common.error[config.reqSys] + "（" + data.ReqType + "）");
					}
				});
			});
		}
		mui('.mui-numbox').on('change', '.mui-input-numbox', function() {			
			//alert(mui($(this).parent()[0]).numbox().getValue());
			console.log($(this).parent());
		});
		var listPro={};
		function initPage(data) {
			console.log(JSON.stringify(data));
			var contain = document.getElementById('OA_task_1');
			console.log(contain);
			contain.innerHTML = "";
			var totalMoney=0;
			var totalIntegral=0;
			for(var i=0;i<data.RetData.length;i++){
				var li = document.createElement('li');
				li.setAttribute("data-prodid",data.RetData[i].ProdID);
				li.className = 'mui-table-view-cell mui-media';
				var html='';
				console.log(i);
				html+='<div class="mui-slider-right mui-disabled"><a class="mui-btn mui-btn-red" id="delete">'+tempJson.shopui.shoppingCar.deletes[config.reqSys]+'</a></div>';
				html+='<div class="mui-slider-handle">';
				html+='<img class="mui-media-object mui-pull-left" style="line-height: 100px;max-width: 100px;height: 100px;" src="'+config.urlPicRoot +data.RetData[i].PicMain+'"><div class="mui-media-body">';
				html+='<dl>';
				html+='<dt id="title">'+data.RetData[i].ProdNo+':'+data.RetData[i].ProdName+'</dt>';
				html+=tempJson.shopui.shoppingCar.amount[config.reqSys]+'<div class="mui-numbox" data-numbox-min="1">';
				html+='<button class="mui-btn mui-btn-numbox-minus" type="button" disabled>-</button>';
				html+='<input class="mui-input-numbox" type="number" data-prodid="'+data.RetData[i].ProdID+'" value="'+data.RetData[i].ProdNum+'"/>';
				html+='<button class="mui-btn mui-btn-numbox-plus" type="button">+</button></div>';
				html+='<dd id="price"><span>'+tempJson.shopui.shoppingCar.price[config.reqSys]+'</span >'+data.RetData[i].PPrice+'<span>&nbsp;'+tempJson.shopui.shoppingCar.integral[config.reqSys]+'</span>'+data.RetData[i].PInteg+'</dd>';
				html+='<h3 id="totalprice" style="" ><span class="totalprice">'+data.RetData[i].ProdMoney+'</span>&nbsp;<span style="font-size:12px;color:red">'+tempJson.shopui.shoppingCar.totalintegral[config.reqSys]+'<span class="totalinteg">'+data.RetData[i].ProdInteg+'</span><span></h3></dl>';
				html+='</div></div>';
				li.innerHTML = html;
				contain.appendChild(li);
				mui('.mui-numbox').numbox(); 
				listPro["ProdID"+data.RetData[i].ProdID]=data.RetData[i];
				console.log(data.RetData[i].ProdID);
				totalMoney+=data.RetData[i].ProdMoney;
				totalIntegral+=data.RetData[i].ProdInteg;
				console.log(JSON.stringify(listPro));
			}		
			//mui.init();
			txtChange();
// 			var money = document.getElementById('money');
// 			money.innerHTML =totalMoney;
// 			var integral = document.getElementById('integral');
// 			integral.innerHTML = totalIntegral;
			
		}
		
		function jqAjax() {
			var arg = arguments;
			$.ajax({
				async: true, //表示请求是否异步处理
				timeout: 50000,
				type: "post", //请求类型
				url: config.url, //请求的 URL地址
				data: JSON.stringify(arg[0]),
				contentType: "application/json",
				dataType: "json", //返回的数据类型
				success: function(data) {
					console.log(JSON.stringify(data)); //在控制台打印服务器端返回的数据						
					if (data.RetFlag < 0) {
						mui.toast(data.RetInfo);
						return;
					} else {
						if (typeof arg[1] === "function") {
							//调用它，既然我们已经确定了它是可调用的
							callback = arg[1];
							callback(data);
						}
					}
				},
				error: function(data) {
					console.log(JSON.stringify(data));
					mui.toast(tempJson.common.error[config.reqSys] + "（" + data.ReqType + "）");
				}
			});
		}
	</script>
	<!--App自定义的css-->
	<link rel="stylesheet" type="text/css" href="../css/app.css" />
	<script>
		mui.init();
		(function(mui) {
			mui('#OA_task_1').on('tap', '.mui-slider-right .mui-btn', function(event) {
				var elem = this;
				var li = elem.parentNode.parentNode;
				var id=li.getAttribute("data-prodid");
				
				mui.confirm(tempJson.shopui.shoppingCar.makesure[config.reqSys], 'eternal', btnArray, function(e) {
					console.log(id);
					
					if (e.index == 0) {
						var param = {
							"ReqSys": config.reqSys,
							"ReqKey": userInfo.UserID,
							"ReqPwd": userInfo.PwdTmp,
							"ReqType": "ScShopCartUp",
							"ReqData": {
								"ProdID": id, // 商品ID
								"ProdNum": 0 // 商品数量，小于等于0时，表示删除，否则表示添加或修改
							}
						};
						$.ajax({
							async: true, //表示请求是否异步处理
							timeout: 50000,
							type: "post", //请求类型
							url: config.url, //请求的 URL地址
							data: JSON.stringify(param),
							contentType: "application/json",
							dataType: "json", //返回的数据类型
							success: function(data) {
								console.log(JSON.stringify(data)); //在控制台打印服务器端返回的数据						
								if (data.RetFlag < 0) {
									mui.toast(data.RetInfo);
									return;
								} else {
									li.parentNode.removeChild(li);
								}
							},
							error: function(data) {
								console.log(JSON.stringify(data));
								mui.toast(tempJson.common.error[config.reqSys] + "（" + data.ReqType + "）");
							}
						});
					} else {
						setTimeout(function() {
							mui.swipeoutClose(li);
						}, 0);
					}
				});
			});
			var btnArray = [tempJson.common.submit[config.reqSys], tempJson.common.cancel[config.reqSys]];
		})(mui);
		 $(document).ready(function(){
			 config.reqSys=app.getLanguage().language;
			initHTML();
		});
		function initHTML(){
			$("#index").text(tempJson.shopui.footer.index[config.reqSys]);
			$("#shoppingCar").text(tempJson.shopui.footer.shoppingCar[config.reqSys]);
			$("#order").text(tempJson.shopui.footer.order[config.reqSys]);
			$("#mainPage").text(tempJson.shopui.footer.mainPage[config.reqSys]);
			
			$("#header").text(tempJson.shopui.shoppingCar.header[config.reqSys]);
			$("#submit").text(tempJson.shopui.shoppingCar.liquidation[config.reqSys]);
		}
	</script>
</html>
